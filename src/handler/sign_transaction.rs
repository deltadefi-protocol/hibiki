use whisky::{calculate_tx_hash, CSLParser, WError, Wallet};

use crate::services::{SignTransactionRequest, SignTransactionResponse};

pub fn check_signature_sign_tx(wallet: &Wallet, tx_hex: &str) -> Result<String, WError> {
    let signed_tx = wallet.sign_tx(tx_hex).unwrap();

    let mut tx_parser = CSLParser::new_with_body(&signed_tx)?;
    let is_transaction_fully_signed =
        tx_parser
            .check_all_required_signers(tx_hex)
            .map_err(WError::from_err(
                "SignTransaction - check_all_required_signers",
            ))?;

    if !is_transaction_fully_signed {
        return Err(WError::new(
            "SignTransaction - check_all_required_signers",
            "Transaction is not fully signed",
        ));
    }
    Ok(signed_tx)
}

pub fn handler(
    request: SignTransactionRequest,
    app_owner_wallet: &Wallet,
) -> Result<SignTransactionResponse, WError> {
    let tx_hex = request.tx_hex;
    let signed_tx = check_signature_sign_tx(&app_owner_wallet, &tx_hex)?;
    let tx_hash = calculate_tx_hash(&signed_tx)?;
    let reply = SignTransactionResponse { signed_tx, tx_hash };
    Ok(reply)
}

#[cfg(test)]
mod tests {
    use crate::utils::wallet::get_app_owner_wallet;

    use super::*;
    use dotenv::dotenv;

    #[test]
    fn test_app_sign_tx_missing_user_sign() {
        dotenv().ok();
        let app_owner_wallet = get_app_owner_wallet();
        let tx_hex = "84a800d9010281825820e38178967c200c81b4d7052e81de78a32c22a1ca26c1737f04643d5ee237ad9419020a0182a300581d70eb0a5938244e92fd172560f530bf959724b10353a26f276ea8bbb3cc018200a1581c463e70d04718e253757523698184cb7090b0430e89dc025c4c8e392ca14001028201d81858c7d87c9fd8799fd8799f50fb73c3bd256949a480c47abaad3dfa4fd8799f581c04845038ee499ee8bc0afe56f688f27b2dd76f230d3698a9afcc1b66ffd8799f581c71052cf0c2562d16eedd20e6e22e5b82173630f9a45ff8d42c38e29fffffffd8799fd8799f50e0e1622f99434f2c867afc3dcb6732b3d8799f581cfdeb4bf0e8c077114a4553f1e05395e9fb7114db177f02f7b65c8de4ffd8799f581c229d96e64aa5878fc93ba2ee9081126052d62974da032f1e5998be5dffffffa140a1401a000f4240ff82583900fa5136e9e9ecbc9071da73eeb6c9a4ff73cbf436105cf8380d1c525c89a2f36d3033bf4be236847143916e2e237de49069844934ac88f4e500020009a1581c463e70d04718e253757523698184cb7090b0430e89dc025c4c8e392ca140010b58208ba3b26901576dfc1757835eca10292d9d0324e3779e9b15b908e4f7459edcb90dd9010281825820e38178967c200c81b4d7052e81de78a32c22a1ca26c1737f04643d5ee237ad941903e80ed9010282581cfa5136e9e9ecbc9071da73eeb6c9a4ff73cbf436105cf8380d1c525c581c04845038ee499ee8bc0afe56f688f27b2dd76f230d3698a9afcc1b6612d9010281825820ace128c7ab85836aed1f4f188df6a85e6b103d21518af570fa81deaef6018ff400a207d901028158b558b30101009800aba2a6011e581cfa5136e9e9ecbc9071da73eeb6c9a4ff73cbf436105cf8380d1c525c00a6010746382d6d696e740048c8c8c8c88c88966002646464646464660020026eb0c038c03cc03cc03cc03cc03cc03cc03cc03cc030dd5180718061baa0072259800800c52844c96600266e3cdd71808001005c528c4cc00c00c00500d1808000a01c300c300d002300b001300b002300900130063754003149a26cac8028dd7000ab9a5573caae7d5d0905a182010082d87f9fd8799fd8799f50fb73c3bd256949a480c47abaad3dfa4fd8799f581c04845038ee499ee8bc0afe56f688f27b2dd76f230d3698a9afcc1b66ffd8799f581c71052cf0c2562d16eedd20e6e22e5b82173630f9a45ff8d42c38e29fffffffd8799fd8799f50e0e1622f99434f2c867afc3dcb6732b3d8799f581cfdeb4bf0e8c077114a4553f1e05395e9fb7114db177f02f7b65c8de4ffd8799f581c229d96e64aa5878fc93ba2ee9081126052d62974da032f1e5998be5dffffffa140a1401a000f4240ff820000f5f6".to_string();
        let result = check_signature_sign_tx(&app_owner_wallet, &tx_hex);
        assert!(result.is_err());
    }

    #[test]
    fn test_app_sign_tx_missing_owner_sign() {
        dotenv().ok();
        let app_owner_wallet = get_app_owner_wallet();
        let tx_hex = "84ab00d90102828258202226f02050d316d67e7ae8db009d5f13c6a087a68dd759b9bfe86a9b168395a0008258208ad5f947390ecfc47713e18b8b129e82fdc665a00e9b6bffeb29930c33c741f2000182a300581d70fc7ceb16ea99f649756ee4dfb751f5e9658ec521be932b0b09a7764401821b000000746a528800a2581c8314347e7b015d8adb3fd6d751df32213bd55cfd0212e9526ca729d5a14001581cc69b981db7a65e339a6d783755f85a2e03afa1cece9714c55fe4c913a1445553444d1b000000746a528800028201d818589bd8799fd8799fd8799f50d15fa6855bba4cf0ac89d60e47feb5e4d8799f581cfdeb4bf0e8c077114a4553f1e05395e9fb7114db177f02f7b65c8de4ffd8799f581cb21f857716821354725bc2bd255dc2e5d5fdfa202556039b76c080a5ffffffa240a1401b000000746a528800581cc69b981db7a65e339a6d783755f85a2e03afa1cece9714c55fe4c913a1445553444d1b000000746a528800ff82583900fdeb4bf0e8c077114a4553f1e05395e9fb7114db177f02f7b65c8de44e660f79ce4221d52a2dc249da925112b3ea46bcaba9ce48174fa358821a001a4238a1581cc69b981db7a65e339a6d783755f85a2e03afa1cece9714c55fe4c913a1445553444d1b000008a3e4201800021a00044248075820bdaa99eb158414dea0a91d6c727e2268574b23efe6e08ab3b841abe8059a030c09a1581c8314347e7b015d8adb3fd6d751df32213bd55cfd0212e9526ca729d5a140010b5820c9ce910cccbc274cc3d17e1447570eeb86f7f04a3a04c1f0955f8a71d08cfd5e0dd901028182582025570ee8a715b9425d98eb6b23f94b39a794889a46fa64059cc17d9c37d10e1a000ed9010281581cfa5136e9e9ecbc9071da73eeb6c9a4ff73cbf436105cf8380d1c525c1082583900fdeb4bf0e8c077114a4553f1e05395e9fb7114db177f02f7b65c8de44e660f79ce4221d52a2dc249da925112b3ea46bcaba9ce48174fa3581a002dc6c0111a001e848012d901028282582018c91dd7f5a94060d30d1f8fad1534d7ec1d890b8e9c1423de4c53bc2a4fde5e00825820b6f26af61a6739317a38f2b5f39c6c04ec3e20aa5d072c4b03cff9668c8c1cc500a200d90102818258206a82252080ab04f55a6e04cf93fbb2f13d6a34a6dcc2cd0568d57cc2296ba6405840e58110ad154f07ee30a9c67182f43ddae888b7bb6e1c3a9970182b00fc7a8ae9527a39e35d0219bc5a1e845f5217020d1f64c54a735e75221e93cab4622f640305a182010082d87980821a000650011a07f75f24f5d90103a0".to_string();
        let result = check_signature_sign_tx(&app_owner_wallet, &tx_hex);
        assert!(result.is_ok());
    }

    #[test]
    fn test_app_sign_tx_all_signed() {
        dotenv().ok();
        let app_owner_wallet = get_app_owner_wallet();
        let tx_hex = "84a400d9010281825820e05c49b5f7bfb05ce2cb589e0e652dbf1967398fda55718c427693d4be4e9fd80101828258390004845038ee499ee8bc0afe56f688f27b2dd76f230d3698a9afcc1b66e0464447c1f51adaefe1ebfb0dd485a349a70479ced1d198cbdf7fe7821a05f5e100a1581cc69b981db7a65e339a6d783755f85a2e03afa1cece9714c55fe4c913a1445553444d1a05f5e100825839001434db8b992d8bd16ed71c521d0def5811f637d6509d8d4f620ad03ee1041668e7fd16cb2fd97e1995e1016c37f5766f387333c38185f66b821a35654c3aa2581cb80aa257a376c9ae7aa0c7a323db88d236e11e0a5ed5e10142da9ea0a14a000de14074657374313101581cc69b981db7a65e339a6d783755f85a2e03afa1cece9714c55fe4c913a1445553444d1b00000001d6e06f00021a0002aee1075820bdaa99eb158414dea0a91d6c727e2268574b23efe6e08ab3b841abe8059a030ca10081825820ee9f3061a3a5756ad2e25629e69b927b890b137e68d1c25947fc8b7da3b4445258402fcd7eb1279ca347eb139229c75f56d1c88bd1234038d22c0c3194307c0e4ebd124d415f6a86a4c3f0f2dccfa487e4f4996d7c8b661807bccff659973bc8a402f5d90103a0".to_string();
        let result = check_signature_sign_tx(&app_owner_wallet, &tx_hex);
        assert!(result.is_ok());
    }
}
